name: Deploy to Hugging Face Space

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-peakpilot
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Ensure HF token present
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          if [ -z "$HF_TOKEN" ]; then
            echo "::error::Missing HF_TOKEN secret (Hugging Face write token)"; exit 1;
          fi

      - name: Setup Git LFS
        run: git lfs install

      # Build a README that has the Spaces front-matter and COMMIT it
      - name: Build HF README with front-matter
        run: |
          cat > _hf_header.yml <<'YAML'
          ---
          title: PeakPilot
          emoji: ðŸŽšï¸
          colorFrom: indigo
          colorTo: purple
          sdk: docker
          app_port: 7860
          pinned: false
          ---
          YAML
          cp README.md README.github.md || true
          if [ -f README.md ]; then
            cat _hf_header.yml README.md > README.hf.md
          else
            cp _hf_header.yml README.hf.md
          fi
          mv README.hf.md README.md

      # Track brand assets with LFS for the Space push
      - name: LFS-track brand assets (deploy-only)
        run: |
          git lfs track "app/static/brand/*.png"
          git lfs track "static/brand/*.png"
          git add .gitattributes
          [ -f app/static/brand/peakpilot-logo-1024.png ] && git add -f app/static/brand/peakpilot-logo-1024.png
          [ -f app/static/brand/peakpilot-logo.png ] && git add -f app/static/brand/peakpilot-logo.png
          [ -f static/brand/peakpilot-logo-1024.png ] && git add -f static/brand/peakpilot-logo-1024.png
          [ -f static/brand/peakpilot-logo.png ] && git add -f static/brand/peakpilot-logo.png

      - name: Configure committer
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # *** THIS commits all local changes (README+LFS pointers) so push contains them ***
      - name: Create deploy commit
        run: |
          git add -A
          git commit -m "Deploy to HF (Space-ready files)" || echo "No changes to commit"

      - name: Push repo to HF Space
        env:
          HF_USERNAME: djillegal
          SPACE_NAME: PeakPilot
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          set -e
          git remote add space https://huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME || true
          echo "Before push, remote heads:"
          git ls-remote https://huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME | sed -n '1,5p'
          git push --force https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME HEAD:main
          echo "After push, remote heads:"
          git ls-remote https://huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME | sed -n '1,5p'

name: Deploy to Hugging Face Space

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-peakpilot
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Setup Git LFS
        run: git lfs install

      # Build an HF-specific README by prepending the Spaces front-matter.
      # This commit exists only in the runner and will be pushed to the Space (not back to GitHub).
      - name: Build HF README with front-matter
        run: |
          cat > _hf_header.yml <<'YAML'
          ---
          title: PeakPilot
          emoji: 🎚️
          colorFrom: indigo
          colorTo: purple
          sdk: docker
          app_port: 7860
          pinned: false
          ---
          YAML
          cp README.md README.github.md || true
          if [ -f README.md ]; then
            cat _hf_header.yml README.md > README.hf.md
          else
            cp _hf_header.yml README.hf.md
          fi
          mv README.hf.md README.md

      # Track brand assets with LFS for the Space push only.
      # Covers both possible paths: "app/static/brand" and "static/brand".
      - name: LFS-track brand assets (deploy-only)
        run: |
          git lfs track "app/static/brand/*.png"
          git lfs track "static/brand/*.png"
          git add .gitattributes
          [ -f app/static/brand/peakpilot-logo-1024.png ] && git add -f app/static/brand/peakpilot-logo-1024.png
          [ -f app/static/brand/peakpilot-logo.png ] && git add -f app/static/brand/peakpilot-logo.png
          [ -f static/brand/peakpilot-logo-1024.png ] && git add -f static/brand/peakpilot-logo-1024.png
          [ -f static/brand/peakpilot-logo.png ] && git add -f static/brand/peakpilot-logo.png
          git commit -m "LFS: track brand assets for Space deploy" || true

      - name: Configure committer
        run: |
          git config user.name
